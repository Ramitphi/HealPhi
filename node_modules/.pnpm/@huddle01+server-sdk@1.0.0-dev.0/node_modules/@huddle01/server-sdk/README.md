# @huddle01/server-sdk

## Installation

```bash
npm install @huddle01/server-sdk
```
```bash
yarn add @huddle01/server-sdk
```
```bash
pnpm i @huddle01/server-sdk
```
```bash
bun install @huddle01/server-sdk
```

## Usage

## Webhooks

Helper functions to decode and verify webhook callbacks from Huddle01.


```ts
import { WebhookReceiver } from '@huddle01/server-sdk/webhooks';

const webhookReceiver = new WebhookReceiver({
  apiKey: "YOUR_API_KEY",
  apiSecret: "YOUR_API_SECRET",
});
```

### 1. Next.js Api Route

```ts
export async function POST(request: Request) {
  try {
    const body = await request.json();
    const header = request.headers.get("huddle01-signature");

    const data = webhookReceiver.receive(body, header);

    console.log({ webhookData: data });

    return NextResponse.json({ ok: true });
  } catch (error) {
    console.error(error);
    return NextResponse.json({ ok: false }, { status: 500 });
  }
}
```

### 2. Express
```ts
app.post("/webhooks", async (req, res) => {
  try {
    const body = req.body;
    const header = req.headers["huddle01-signature"];

    const data = webhookReceiver.receive(body, header);

    console.log({ webhookData: data });

    res.status(200).json({ ok: true });
  } catch (error) {
    console.error(error);
    res.status(500).json({ ok: false });
  }
});
```

### Helper to get properly typed data from webhook

```ts
const receivedData = webhookReceiver.receive(body, header);

/**
 * @returns {
 *  event: "meeting:started",
 *  data: {
 *    roomId: string,
 *    createdAt: string,
 *  }
 * }
 */
const { event, data } = webhookReceiver.createTypedWebhookData(
  "meeting:started",
  data.payload,
);

```

## Auth
To enable client apps to establish connections with Huddle01 rooms, they require a token that is produced by your backend server. This guide will lead you through the process of configuring a server to create tokens for your clients.

```ts
import { AccessToken } from '@huddle01/server-sdk/auth';

const accessToken = new AccessToken({
  apiKey: env.API_KEY,
  roomId: "YOUR_ROOM_ID",
  permissions: {
    admin: true,
    canConsume: true,
    canProduce: true,
    canProduceSources: ['cam', 'mic', 'screen-share'],
    canRecvData: true,
    canSendData: true,
    canUpdateMetadata: true,
  },
  options: {
    metadata: { CUSTOM_KEY: "CUSTOM_VALUE" }, // Custom metadata according to your app logic
  },
})

const token = await accessToken.toJwt();

console.log({ token });
```

## Recording/ Livestreaming

Server side helpers to start/stop recording and livestreaming

```ts
import { Recorder } from '@huddle01/server-sdk/recorder';

const recorder = new Recorder("API_KEY", "API_SECRET");
```

### 1. Start recording 

```ts
/**
 * @returns {
 *  msg: string,
 * }
 */
const recording = await recorder.startRecording({ roomId: "ROOM_ID", token: "TOKEN_FOR_RECORDER" });

console.log({ recording });
```

### 2. Start Livestream

Start a livestream and we can stream it to multiple RTMP endpoints.

```ts
/**
 * @returns {
 *  msg: string,
 * }
 */
const recording = await recorder.startLivestream({ 
  roomId: "ROOM_ID",
  token: "TOKEN_FOR_RECORDER" ,
  rtmpUrls: ["rtmp://example.com/live"],
});

console.log({ recording });
```

### 3. Stop recording/livestream

```ts
/**
 * @returns {
 *  msg: string,
 * }
 */
await recorder.stop({ roomId: "ROOMID" });
```